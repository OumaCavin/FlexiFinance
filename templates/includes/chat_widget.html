<!-- Chat Widget -->
<div id="chat-widget" class="chat-widget">
    <!-- Chat Button -->
    <div id="chat-button" class="chat-button" onclick="toggleChat()">
        <div class="chat-button-content">
            <i class="fas fa-comments" id="chat-icon"></i>
            <span class="chat-button-text">Need Help?</span>
        </div>
        <div class="chat-notification" id="chat-notification" style="display: none;">
            <i class="fas fa-circle"></i>
        </div>
    </div>
    
    <!-- Chat Window -->
    <div id="chat-window" class="chat-window" style="display: none;">
        <!-- Chat Header -->
        <div class="chat-header">
            <div class="chat-header-info">
                <div class="chat-avatar">
                    <i class="fas fa-user-tie"></i>
                </div>
                <div class="chat-details">
                    <div class="chat-title">FlexiFinance Support</div>
                    <div class="chat-status">
                        <span class="status-dot online"></span>
                        <span id="chat-status-text">Online - Usually replies instantly</span>
                    </div>
                </div>
            </div>
            <div class="chat-actions">
                <button class="chat-action-btn" onclick="minimizeChat()" title="Minimize">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="chat-action-btn" onclick="closeChat()" title="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <!-- Chat Messages -->
        <div id="chat-messages" class="chat-messages">
            <!-- Welcome Message -->
            <div class="message bot-message">
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="message-text">
                            Hello! ðŸ‘‹ I'm here to help you with FlexiFinance. How can I assist you today?
                        </div>
                        <div class="message-time">just now</div>
                    </div>
                    <div class="quick-actions">
                        <button class="quick-action" onclick="sendQuickMessage('loan-application')">ðŸ’° Apply for a Loan</button>
                        <button class="quick-action" onclick="sendQuickMessage('check-status')">ðŸ“Š Check Loan Status</button>
                        <button class="quick-action" onclick="sendQuickMessage('payment-help')">ðŸ’³ Payment Help</button>
                        <button class="quick-action" onclick="sendQuickMessage('technical-support')">ðŸ”§ Technical Support</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat Input -->
        <div class="chat-input-container">
            <form id="chat-form" onsubmit="sendMessage(event)">
                <div class="chat-input-wrapper">
                    <input type="text" id="chat-input" class="chat-input" placeholder="Type your message..." autocomplete="off">
                    <button type="submit" class="chat-send-btn" id="chat-send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </form>
            <div class="chat-footer">
                <small class="text-muted">
                    <i class="fas fa-shield-alt me-1"></i>
                    Your conversation is secure and confidential
                </small>
            </div>
        </div>
    </div>
</div>

<style>
.chat-widget {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1050;
    font-family: var(--font-family-primary);
}

.chat-button {
    background: var(--gradient-primary);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 15px 20px;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 10px;
    position: relative;
    overflow: hidden;
}

.chat-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(102, 126, 234, 0.4);
}

.chat-button-content {
    display: flex;
    align-items: center;
    gap: 10px;
}

.chat-button-text {
    font-weight: 600;
    font-size: 14px;
    white-space: nowrap;
}

.chat-icon {
    font-size: 18px;
    animation: pulse 2s infinite;
}

.chat-notification {
    position: absolute;
    top: -5px;
    right: -5px;
    color: var(--error-color);
    animation: bounce 1s infinite;
}

.chat-window {
    position: absolute;
    bottom: 80px;
    right: 0;
    width: 350px;
    height: 500px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    animation: slideUp 0.3s ease-out;
    border: 1px solid var(--gray-200);
}

.chat-header {
    background: var(--gradient-primary);
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-header-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.chat-avatar {
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
}

.chat-title {
    font-weight: 600;
    font-size: 16px;
    margin-bottom: 2px;
}

.chat-status {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 12px;
    opacity: 0.9;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--success-color);
    animation: pulse 2s infinite;
}

.chat-actions {
    display: flex;
    gap: 5px;
}

.chat-action-btn {
    background: none;
    border: none;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    transition: background 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.chat-action-btn:hover {
    background: rgba(255, 255, 255, 0.2);
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: var(--gray-50);
}

.message {
    display: flex;
    margin-bottom: 15px;
    animation: fadeInUp 0.3s ease-out;
}

.message.user-message {
    flex-direction: row-reverse;
}

.message-avatar {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
}

.bot-message .message-avatar {
    background: var(--primary-color);
    color: white;
}

.user-message .message-avatar {
    background: var(--gray-600);
    color: white;
}

.message-content {
    max-width: 80%;
    margin: 0 10px;
}

.user-message .message-content {
    margin: 0 0 0 10px;
}

.message-bubble {
    background: white;
    padding: 12px 16px;
    border-radius: 18px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    position: relative;
}

.user-message .message-bubble {
    background: var(--primary-color);
    color: white;
}

.message-text {
    line-height: 1.4;
    word-wrap: break-word;
}

.message-time {
    font-size: 11px;
    opacity: 0.7;
    margin-top: 5px;
    text-align: right;
}

.quick-actions {
    margin-top: 12px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.quick-action {
    background: var(--gray-100);
    border: 1px solid var(--gray-200);
    border-radius: 20px;
    padding: 6px 12px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.quick-action:hover {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.chat-input-container {
    border-top: 1px solid var(--gray-200);
    background: white;
}

.chat-input-wrapper {
    display: flex;
    padding: 15px 20px;
    gap: 10px;
}

.chat-input {
    flex: 1;
    border: 1px solid var(--gray-300);
    border-radius: 25px;
    padding: 12px 16px;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s ease;
}

.chat-input:focus {
    border-color: var(--primary-color);
}

.chat-send-btn {
    background: var(--primary-color);
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.chat-send-btn:hover {
    background: var(--primary-dark);
    transform: scale(1.05);
}

.chat-send-btn:disabled {
    background: var(--gray-300);
    cursor: not-allowed;
    transform: none;
}

.chat-footer {
    padding: 0 20px 15px;
    text-align: center;
}

/* Animations */
@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
    }
    40% {
        transform: translateY(-10px);
    }
    60% {
        transform: translateY(-5px);
    }
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .chat-widget {
        bottom: 15px;
        right: 15px;
    }
    
    .chat-window {
        width: calc(100vw - 30px);
        height: calc(100vh - 100px);
        max-height: 500px;
        bottom: 70px;
        right: 0;
    }
    
    .chat-button {
        padding: 12px 16px;
    }
    
    .chat-button-text {
        display: none;
    }
    
    .quick-actions {
        flex-direction: column;
    }
    
    .quick-action {
        text-align: left;
    }
}

/* Typing indicator */
.typing-indicator {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 8px 0;
}

.typing-dot {
    width: 6px;
    height: 6px;
    background: var(--gray-400);
    border-radius: 50%;
    animation: typingPulse 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: 0s; }
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typingPulse {
    0%, 80%, 100% {
        transform: scale(1);
        opacity: 0.5;
    }
    40% {
        transform: scale(1.2);
        opacity: 1;
    }
}

/* Chat window minimized state */
.chat-window.minimized {
    height: 60px;
}

.chat-window.minimized .chat-messages,
.chat-window.minimized .chat-input-container {
    display: none;
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .chat-window {
        background: var(--gray-800);
        color: var(--gray-100);
        border-color: var(--gray-700);
    }
    
    .chat-messages {
        background: var(--gray-900);
    }
    
    .message-bubble {
        background: var(--gray-700);
        color: var(--gray-100);
    }
    
    .chat-input {
        background: var(--gray-700);
        border-color: var(--gray-600);
        color: var(--gray-100);
    }
    
    .quick-action {
        background: var(--gray-600);
        border-color: var(--gray-500);
        color: var(--gray-100);
    }
    
    .quick-action:hover {
        background: var(--primary-color);
    }
}
</style>

<script>
let chatOpen = false;
let chatMinimized = false;
let messageId = 0;

// Chat functionality
function toggleChat() {
    const chatWindow = document.getElementById('chat-window');
    const chatIcon = document.getElementById('chat-icon');
    const chatButton = document.getElementById('chat-button');
    
    if (chatOpen) {
        closeChat();
    } else {
        chatWindow.style.display = 'flex';
        chatIcon.className = 'fas fa-times';
        chatButton.classList.add('chat-open');
        chatOpen = true;
        
        // Focus on input
        setTimeout(() => {
            document.getElementById('chat-input').focus();
        }, 300);
        
        // Hide notification
        document.getElementById('chat-notification').style.display = 'none';
        
        // Track event
        FlexiFinance.trackEvent('chat_opened', {
            page_location: window.location.href
        });
    }
}

function closeChat() {
    const chatWindow = document.getElementById('chat-window');
    const chatIcon = document.getElementById('chat-icon');
    const chatButton = document.getElementById('chat-button');
    
    chatWindow.style.display = 'none';
    chatIcon.className = 'fas fa-comments';
    chatButton.classList.remove('chat-open');
    chatOpen = false;
    
    // Track event
    FlexiFinance.trackEvent('chat_closed', {
        page_location: window.location.href
    });
}

function minimizeChat() {
    const chatWindow = document.getElementById('chat-window');
    chatWindow.classList.toggle('minimized');
    chatMinimized = !chatMinimized;
}

function sendMessage(event) {
    event.preventDefault();
    
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message
    addMessage(message, 'user');
    
    // Clear input
    input.value = '';
    
    // Show typing indicator
    showTypingIndicator();
    
    // Process message and respond
    setTimeout(() => {
        hideTypingIndicator();
        processMessage(message);
    }, 1000 + Math.random() * 2000); // Random delay between 1-3 seconds
    
    // Track event
    FlexiFinance.trackEvent('chat_message_sent', {
        message_length: message.length,
        page_location: window.location.href
    });
}

function sendQuickMessage(type) {
    const messages = {
        'loan-application': 'I want to apply for a loan. Can you help me?',
        'check-status': 'I want to check my loan application status.',
        'payment-help': 'I need help with making a payment.',
        'technical-support': 'I have a technical issue with my account.'
    };
    
    const message = messages[type] || 'Hello, I need help.';
    document.getElementById('chat-input').value = message;
    sendMessage({ preventDefault: () => {} });
}

function addMessage(content, sender) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    const avatar = sender === 'user' ? 'user' : 'bot';
    const avatarIcon = sender === 'user' ? 'fas fa-user' : 'fas fa-robot';
    
    messageDiv.innerHTML = `
        <div class="message-avatar">
            <i class="${avatarIcon}"></i>
        </div>
        <div class="message-content">
            <div class="message-bubble">
                <div class="message-text">${content}</div>
                <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
            </div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Animate message
    messageDiv.style.animation = 'fadeInUp 0.3s ease-out';
}

function showTypingIndicator() {
    const messagesContainer = document.getElementById('chat-messages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message bot-message typing-message';
    typingDiv.id = 'typing-indicator';
    
    typingDiv.innerHTML = `
        <div class="message-avatar">
            <i class="fas fa-robot"></i>
        </div>
        <div class="message-content">
            <div class="message-bubble">
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>
    `;
    
    messagesContainer.appendChild(typingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

function processMessage(message) {
    const lowerMessage = message.toLowerCase();
    let response = '';
    let quickActions = [];
    
    // Simple keyword-based responses
    if (lowerMessage.includes('loan') || lowerMessage.includes('apply')) {
        response = 'Great! I can help you apply for a loan. We offer personal loans from KSh 5,000 to KSh 500,000 with flexible repayment terms. Would you like me to connect you with a loan specialist or would you prefer to apply online?';
        quickActions = [
            { text: 'ðŸ’° Start Online Application', action: 'redirect', value: '/loan-application/' },
            { text: 'ðŸ“ž Speak to Specialist', action: 'phone', value: '+254708101604' }
        ];
    } else if (lowerMessage.includes('status') || lowerMessage.includes('check')) {
        response = 'I can help you check your loan status. Please provide your application ID or phone number so I can look up your information.';
        quickActions = [
            { text: 'ðŸ“Š Login to Account', action: 'redirect', value: '/login/' },
            { text: 'ðŸ“ž Call Support', action: 'phone', value: '+254708101604' }
        ];
    } else if (lowerMessage.includes('payment') || lowerMessage.includes('pay')) {
        response = 'I can help you with your payment. You can pay via M-PESA, bank transfer, or credit card. What payment method would you prefer?';
        quickActions = [
            { text: 'ðŸ’³ Pay via M-PESA', action: 'redirect', value: '/payment/mpesa/' },
            { text: 'ðŸ¦ Bank Transfer', action: 'info', value: 'bank-details' }
        ];
    } else if (lowerMessage.includes('technical') || lowerMessage.includes('problem') || lowerMessage.includes('issue')) {
        response = 'I understand you\'re experiencing a technical issue. Let me connect you with our technical support team who can help resolve this quickly.';
        quickActions = [
            { text: 'ðŸ”§ Get Technical Support', action: 'phone', value: '+254708101604' },
            { text: 'ðŸ“§ Email Support', action: 'email', value: 'support@flexifinance.com' }
        ];
    } else if (lowerMessage.includes('help') || lowerMessage.includes('support')) {
        response = 'I\'m here to help! I can assist you with loan applications, account questions, payment issues, and technical support. What specifically do you need help with?';
        quickActions = [
            { text: 'ðŸ’° Loan Application', action: 'quick', value: 'loan-application' },
            { text: 'ðŸ’³ Payment Help', action: 'quick', value: 'payment-help' },
            { text: 'ðŸ“Š Check Status', action: 'quick', value: 'check-status' }
        ];
    } else {
        response = 'Thank you for your message. I\'m here to help with FlexiFinance-related questions. For complex inquiries, I can connect you with our support team. How can I assist you today?';
        quickActions = [
            { text: 'ðŸ’° Apply for Loan', action: 'quick', value: 'loan-application' },
            { text: 'ðŸ“ž Call Support', action: 'phone', value: '+254708101604' },
            { text: 'ðŸ“§ Email Us', action: 'email', value: 'support@flexifinance.com' }
        ];
    }
    
    // Add response message
    addMessage(response, 'bot');
    
    // Add quick actions if available
    if (quickActions.length > 0) {
        setTimeout(() => {
            addQuickActions(quickActions);
        }, 500);
    }
}

function addQuickActions(actions) {
    const messagesContainer = document.getElementById('chat-messages');
    const quickActionsDiv = document.createElement('div');
    quickActionsDiv.className = 'quick-actions';
    
    actions.forEach(action => {
        const button = document.createElement('button');
        button.className = 'quick-action';
        button.textContent = action.text;
        button.onclick = () => handleQuickAction(action);
        quickActionsDiv.appendChild(button);
    });
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message bot-message';
    messageDiv.innerHTML = `
        <div class="message-avatar">
            <i class="fas fa-robot"></i>
        </div>
        <div class="message-content">
            <div class="message-bubble">
                ${quickActionsDiv.outerHTML}
            </div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function handleQuickAction(action) {
    switch (action.action) {
        case 'quick':
            sendQuickMessage(action.value);
            break;
        case 'redirect':
            window.open(action.value, '_blank');
            FlexiFinance.trackEvent('chat_redirect', {
                url: action.value,
                page_location: window.location.href
            });
            break;
        case 'phone':
            window.open(`tel:${action.value}`, '_blank');
            FlexiFinance.trackEvent('chat_phone_click', {
                phone: action.value,
                page_location: window.location.href
            });
            break;
        case 'email':
            window.open(`mailto:${action.value}`, '_blank');
            FlexiFinance.trackEvent('chat_email_click', {
                email: action.value,
                page_location: window.location.href
            });
            break;
        case 'info':
            addMessage('Please contact our support team for detailed information.', 'bot');
            break;
    }
}

// Initialize chat widget
document.addEventListener('DOMContentLoaded', function() {
    // Auto-open chat after 30 seconds for engaged users
    setTimeout(() => {
        if (!chatOpen && !document.hidden) {
            // Show notification instead of auto-opening
            document.getElementById('chat-notification').style.display = 'block';
        }
    }, 30000);
    
    // Handle input changes
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('chat-send-btn');
    
    chatInput.addEventListener('input', function() {
        sendBtn.disabled = this.value.trim() === '';
    });
    
    // Handle keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === '/') {
            e.preventDefault();
            toggleChat();
        }
    });
    
    // Update chat status based on business hours
    updateChatStatus();
});

function updateChatStatus() {
    const statusText = document.getElementById('chat-status-text');
    const now = new Date();
    const hour = now.getHours();
    
    let status = 'Online - Usually replies instantly';
    let statusClass = 'online';
    
    // Business hours: 8 AM - 6 PM
    if (hour < 8 || hour >= 18) {
        status = 'Away - We\'ll respond soon';
        statusClass = 'away';
    }
    
    statusText.textContent = status;
    
    // Update status indicator
    const statusDot = document.querySelector('.status-dot');
    statusDot.className = `status-dot ${statusClass}`;
}

// Update chat status every minute
setInterval(updateChatStatus, 60000);

// Show chat notification for new messages (would be triggered by server events)
function showChatNotification() {
    if (!chatOpen) {
        document.getElementById('chat-notification').style.display = 'block';
        
        // Add bounce animation
        const chatButton = document.getElementById('chat-button');
        chatButton.style.animation = 'bounce 0.5s ease';
        setTimeout(() => {
            chatButton.style.animation = '';
        }, 500);
    }
}
</script>