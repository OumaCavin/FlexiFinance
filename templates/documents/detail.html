{% extends 'base.html' %}
{% load static %}

{% block title %}Document Details - FlexiFinance{% endblock %}

{% block extra_css %}
<style>
    .detail-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .document-header {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 30px;
        margin-bottom: 20px;
    }
    
    .status-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .status-pending { background: #ffc107; color: #212529; }
    .status-approved { background: #28a745; color: white; }
    .status-rejected { background: #dc3545; color: white; }
    .status-expired { background: #6c757d; color: white; }
    .status-auto_approved { background: #17a2b8; color: white; }
    
    .info-section {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 25px;
        margin-bottom: 20px;
    }
    
    .file-preview {
        text-align: center;
        padding: 40px;
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .alert-info {
        border-left: 4px solid #17a2b8;
    }
    
    .alert-danger {
        border-left: 4px solid #dc3545;
    }
    
    .alert-success {
        border-left: 4px solid #28a745;
    }
</style>
{% endblock %}

{% block content %}
<div class="detail-container">
    <!-- Document Header -->
    <div class="document-header">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h2 class="mb-2">{{ document.document_type.name }}</h2>
                <p class="text-muted mb-0">
                    {{ document.original_filename }} • 
                    {{ document.file_size|filesizeformat }} • 
                    {{ document.uploaded_at|date:"F d, Y \a\t g:i A" }}
                </p>
            </div>
            <span class="status-badge status-{{ document.status|lower }}">
                {{ document.get_status_display }}
            </span>
        </div>
        
        {% if document.document_type.description %}
        <div class="mt-3">
            <p class="text-muted">{{ document.document_type.description }}</p>
        </div>
        {% endif %}
    </div>

    <!-- File Preview -->
    <div class="info-section">
        <h4 class="mb-3">Document Preview</h4>
        <div class="file-preview">
            {% if document.get_file_extension == '.pdf' %}
                <i class="fas fa-file-pdf fa-5x text-danger mb-3"></i>
                <p class="text-muted">PDF Document</p>
            {% elif document.get_file_extension in '.jpg,.jpeg,.png' %}
                <i class="fas fa-file-image fa-5x text-primary mb-3"></i>
                <p class="text-muted">Image Document</p>
            {% else %}
                <i class="fas fa-file fa-5x text-secondary mb-3"></i>
                <p class="text-muted">Document File</p>
            {% endif %}
            
            <p><strong>{{ document.original_filename }}</strong></p>
            <p class="text-muted">{{ document.file_size|filesizeformat }}</p>
            
            <div class="action-buttons">
                {% if document.status in 'APPROVED AUTO_APPROVED' %}
                <a href="{% url 'documents:download' document.id %}" class="btn btn-success">
                    <i class="fas fa-download"></i> Download Document
                </a>
                {% endif %}
                
                {% if document.status == 'PENDING' %}
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-clock"></i> This document is under review and cannot be downloaded yet.
                </div>
                {% endif %}
                
                {% if document.status == 'REJECTED' %}
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-times-circle"></i> This document was rejected and cannot be downloaded.
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Document Information -->
    <div class="info-section">
        <h4 class="mb-3">Document Information</h4>
        <div class="row">
            <div class="col-md-6">
                <table class="table table-borderless">
                    <tr>
                        <td><strong>Document Type:</strong></td>
                        <td>{{ document.document_type.name }}</td>
                    </tr>
                    <tr>
                        <td><strong>Purpose:</strong></td>
                        <td>{{ document.document_type.get_required_for_display }}</td>
                    </tr>
                    <tr>
                        <td><strong>File Name:</strong></td>
                        <td>{{ document.original_filename }}</td>
                    </tr>
                    <tr>
                        <td><strong>File Size:</strong></td>
                        <td>{{ document.file_size|filesizeformat }}</td>
                    </tr>
                    <tr>
                        <td><strong>File Type:</strong></td>
                        <td>{{ document.get_file_extension|upper }}</td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <table class="table table-borderless">
                    <tr>
                        <td><strong>Upload Date:</strong></td>
                        <td>{{ document.uploaded_at|date:"F d, Y \a\t g:i A" }}</td>
                    </tr>
                    <tr>
                        <td><strong>Status:</strong></td>
                        <td>{{ document.get_status_display }}</td>
                    </tr>
                    {% if document.verified_at %}
                    <tr>
                        <td><strong>Verified Date:</strong></td>
                        <td>{{ document.verified_at|date:"F d, Y \a\t g:i A" }}</td>
                    </tr>
                    {% endif %}
                    {% if document.verified_by %}
                    <tr>
                        <td><strong>Verified By:</strong></td>
                        <td>{{ document.verified_by.get_full_name }}</td>
                    </tr>
                    {% endif %}
                    {% if document.expires_at %}
                    <tr>
                        <td><strong>Expiry Date:</strong></td>
                        <td>
                            {{ document.expires_at|date:"F d, Y" }}
                            {% if document.expires_at < now %}
                                <span class="badge badge-danger">Expired</span>
                            {% else %}
                                <span class="badge badge-success">Valid</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>

    <!-- Verification Details -->
    {% if document.status == 'REJECTED' and document.rejection_reason %}
    <div class="info-section">
        <h4 class="mb-3">Rejection Details</h4>
        <div class="alert alert-danger" role="alert">
            <h6><i class="fas fa-times-circle"></i> Document Rejected</h6>
            <p class="mb-0"><strong>Reason:</strong> {{ document.rejection_reason }}</p>
            {% if document.verified_by %}
            <p class="mb-0 mt-2"><small>Rejected by {{ document.verified_by.get_full_name }} on {{ document.verified_at|date:"F d, Y \a\t g:i A" }}</small></p>
            {% endif %}
        </div>
        
        {% if document.admin_notes %}
        <div class="alert alert-info" role="alert">
            <h6><i class="fas fa-info-circle"></i> Additional Notes</h6>
            <p class="mb-0">{{ document.admin_notes }}</p>
        </div>
        {% endif %}
        
        <div class="text-center">
            <p class="text-muted mb-3">To resolve this issue, please upload a new document or contact support.</p>
            <a href="{% url 'documents:upload' %}" class="btn btn-primary">
                <i class="fas fa-upload"></i> Upload New Document
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Admin Notes -->
    {% if document.admin_notes %}
    <div class="info-section">
        <h4 class="mb-3">Admin Notes</h4>
        <div class="alert alert-info" role="alert">
            <p class="mb-0">{{ document.admin_notes }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="info-section">
        <h4 class="mb-3">Actions</h4>
        <div class="action-buttons">
            <a href="{% url 'documents:list' %}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> Back to Documents
            </a>
            
            {% if document.status != 'APPROVED' %}
            <button class="btn btn-outline-danger" 
                    onclick="deleteDocument({{ document.id }})">
                <i class="fas fa-trash"></i> Delete Document
            </button>
            {% endif %}
            
            {% if document.status in 'APPROVED AUTO_APPROVED' %}
            <a href="{% url 'documents:upload' %}" class="btn btn-outline-success">
                <i class="fas fa-plus"></i> Upload Another
            </a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // URL configuration
    const deleteUrlBase = `{% url 'documents:delete' 0 %}`.replace('0', '');
    const listUrl = `{% url 'documents:list' %}`;
    
    // Delete document function
    function deleteDocument(documentId) {
        if (confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
            fetch(deleteUrlBase + documentId + '/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = listUrl;
                } else {
                    alert('Delete failed: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Delete failed. Please try again.');
            });
        }
    }
</script>
{% endblock %}